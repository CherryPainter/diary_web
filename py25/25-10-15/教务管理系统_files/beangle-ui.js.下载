/**
 * Beangle, Agile Java/Scala Development Scaffold and Toolkit
 *
 * Copyright (c) 2005-2013, Beangle Software.
 *
 * Beangle is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Lesser General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Beangle is distributed in the hope that it will be useful.
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with Beangle.  If not, see <http://www.gnu.org/licenses/>.
 */
/*----------------------------------------------
 * Beangle UI
 * include ToolBar,Grid,EntityAction
 */
(function( bg, undefined ) {
  bg.alert=function(msg){
    Swal.fire(msg);
  }
  bg.confirm= function(msg,functionOrVariable, functionParameter){
    Swal.fire({
      title: msg,
      text: "请确定后操作",
      icon: 'warning',
      showCancelButton: true
    }).then((result) => {
      if (result.isConfirmed) {
        swalOK(functionOrVariable, functionParameter);
      }
    })

  }
  function swalOK(functionOrVariable, functionParameter) {
    if (functionParameter == null) {
      functionOrVariable();
    } else {
      functionOrVariable(functionParameter);
    }
  }
  bg.uitheme="default"

  function NamedFunction(name,func,objectCount){
    this.name=name;
    this.func=func;
    this.objectCount=(null==objectCount)?'ge0':objectCount;
  }
  /**
   * \u751f\u6210\u4e00\u4e2a\u5de5\u5177\u680f
   * @param divId \u5de5\u5177\u680f\u5bf9\u5e94\u7684div
   * @param title  \u5de5\u5177\u680f\u7684\u6807\u9898
   * @param imageName  \u5de5\u5177\u680f\u9876\u5934\u7684\u56fe\u7247\u540d\u79f0
   */
  function ToolBar(divId,title,imageName,securityButtons){
    this.itemCount=0;
    this.bar=document.getElementById(divId);
    if(null==this.bar){
      //bg.alert("cannot find div with id " + divId);
      return;
    }
    this.bar.innerHTML="";
    this.id=divId;
    this.separator="&nbsp;";
    this.bar.className="toolbar notprint";
    var imageRoot=beangle.getContextPath()+"/static/themes/"+ bg.uitheme +"/icons/",
        imagePath=imageRoot + "16x16/actions/";

    this.setTitle=function(newTitle,imageName){
      if(!newTitle) return;
      if(imageName==null)imageName="action-menu";
      this.title_div.innerHTML=genIconElement(null,imageName) + ''+newTitle+"";// zn \u53bb\u6389<strong>\u6807\u7b7e
    }
    this.setSeparator=function(separator){
      this.separator=separator;
    }
    /**
     * \u8bbe\u7f6e\u62ac\u5934
     */
    this.init = function (title,imageName){
      var title_div = document.createElement('div'), msg_div, items_div;
      title_div.className="toolbar-title";
      this.bar.appendChild(title_div);
      this.title_div=title_div;
      this.setTitle(title,imageName);
      items_div = document.createElement('div');
      items_div.className="toolbar-items btn-group-sm";
      items_div.id=this.id+"_items";
      this.items_div=items_div;
      this.bar.appendChild(items_div);
      //msg_div = document.createElement('div');
      //msg_div.className="toolbar-msg";
      //msg_div.style.display="none";
      //msg_div.id=this.id+"_msg";
      //this.bar.appendChild(msg_div);
    }
    this.init(title,imageName);

    this.addHr=function(){
      hrdiv=this.appendDiv(null,"toolbar-line");
      hrdiv.innerHTML='<img height="1" width="100%" align="top" src="' + imagePath + 'keyline.png" />';
    }

    function genIconElement(action,cssClassOrIconPath){
      /*var cssClass ="action-default";
      if(null != cssClassOrIconPath){
        if(cssClassOrIconPath.indexOf('.')>-1){
          if(cssClassOrIconPath.charAt(0)!='/'){
            cssClassOrIconPath=imagePath+cssClassOrIconPath;
          }
          return '<img class="toolbar-img" src="'+cssClassOrIconPath+'"/>';
        }
        else cssClass=cssClassOrIconPath;
      }
      if(null==cssClassOrIconPath && null != action){
        if(typeof action == "object") action = action.name;
        if(typeof action=="string"){
          if(action.indexOf("add")==0 || action.indexOf("batchAdd")==0 ||action.indexOf("new")==0) cssClass= "action-new";
          else if(action.indexOf("remove")==0||action.indexOf("delete")==0) cssClass="action-edit-delete";
          else if(action.indexOf("update")==0||action.indexOf("edit")==0||action.indexOf("batchEdit")==0) cssClass= "action-update";
          else if(action.indexOf("export")==0) cssClass="action-excel";
          else if(action.indexOf("copy")==0) cssClass="action-edit-copy";
          else if(action.indexOf("print")==0) cssClass= "action-print";
          else if(action.indexOf("refresh")==0) cssClass="action-refresh";
          else if(action.indexOf("close")==0) cssClass="action-close";
          else if(action.indexOf("save")==0) cssClass= "action-save";
          else if(action.indexOf("download")==0) cssClass="action-download";
        }
      }
      return '<span class="toolbar-icon ' + cssClass + '" ></span>';*/
      if (cssClassOrIconPath == "emptyIcon"){
        return "";
      }
      var cssClass ="";
      if(null==cssClassOrIconPath && null != action){
        if(typeof action == "object") action = action.name;
        if(typeof action=="string"){
          if(action.indexOf("add")==0 || action.indexOf("batchAdd")==0 ||action.indexOf("new")==0) cssClass= "fa-plus";
          else if(action.indexOf("remove")==0||action.indexOf("delete")==0) cssClass="fa-trash";
          else if(action.indexOf("update")==0||action.indexOf("edit")==0||action.indexOf("batchEdit")==0) cssClass= "fa-pencil";
          else if(action.indexOf("export")==0) cssClass="fa-file-excel-o";
          else if(action.indexOf("copy")==0) cssClass="fa-copy";
          else if(action.indexOf("print")==0) cssClass= "fa-print";
          else if(action.indexOf("refresh")==0) cssClass="fa-refresh";
          else if(action.indexOf("close")==0) cssClass="fa-close";
          else if(action.indexOf("save")==0) cssClass= "fa-save";
          else if(action.indexOf("download")==0) cssClass="fa-download";
          else if(action.indexOf("import")==0) cssClass="fa-upload";
          else if(action.indexOf("info")==0) cssClass="fa-info-circle";

        }
      }else{
        if (cssClassOrIconPath == "action-downarrow") {
          cssClass = "fa-caret-down";
        }else if(cssClassOrIconPath == "action-close"){
          cssClass="fa-close";
        }else if(cssClassOrIconPath == "action-activate"){
          cssClass="fa-check-circle";
        }else if(cssClassOrIconPath == "action-check"){
          cssClass="fa-check";
        }else if(cssClassOrIconPath == "action-default"){
          cssClass="fa-th-large";
        }else if(cssClassOrIconPath == "action-download"){
          cssClass="fa-download";
        }else if(cssClassOrIconPath == "action-edit-copy"){
          cssClass="fa-copy";
        }else if(cssClassOrIconPath == "action-edit-cut"){
          cssClass="fa-cut";
        }else if(cssClassOrIconPath == "action-edit-delete"){
          cssClass="fa-trash";
        }else if(cssClassOrIconPath == "action-edit-find"){
          cssClass="fa-search";
        }else if(cssClassOrIconPath == "action-freeze"){
          cssClass="fa-minus-circle";
        }else if(cssClassOrIconPath == "action-go-first"){
          cssClass="fa-fast-backward";
        }else if(cssClassOrIconPath == "action-go-home"){
          cssClass="fa-home";
        }else if(cssClassOrIconPath == "action-go-jump"){
          cssClass="fa-mail-forward";
        }else if(cssClassOrIconPath == "action-go-last"){
          cssClass="fa-fast-forward";
        }else if(cssClassOrIconPath == "action-go-next"){
          cssClass="fa-forward";
        }else if(cssClassOrIconPath == "action-go-previous"){
          cssClass="fa-backward";
        }else if(cssClassOrIconPath == "action-help-contents"){
          cssClass="fa-question-circle-o";
        }else if(cssClassOrIconPath == "action-inbox"){
          cssClass="fa-envelope-o";
        }else if(cssClassOrIconPath == "action-info"){
          cssClass="fa-info-circle";
        }else if(cssClassOrIconPath == "action-list"){
          cssClass="fa-list";
        }else if(cssClassOrIconPath == "action-mail-reply"){
          cssClass="fa-mail-reply";
        }else if(cssClassOrIconPath == "action-new"){
          cssClass="fa-plus";
        }else if(cssClassOrIconPath == "action-office-chart-area"){
          cssClass="fa-area-chart";
        }else if(cssClassOrIconPath == "action-office-chart-line"){
          cssClass="fa-line-chart";
        }else if(cssClassOrIconPath == "action-office-chart-pie"){
          cssClass="fa-pie-chart";
        }else if(cssClassOrIconPath == "action-paperclip"){
          cssClass="fa-paperclip";
        }else if(cssClassOrIconPath == "action-print"){
          cssClass="fa-print";
        }else if(cssClassOrIconPath == "action-refresh"){
          cssClass="fa-refresh";
        }else if(cssClassOrIconPath == "action-save"){
          cssClass="fa-save";
        }else if(cssClassOrIconPath == "action-sort-asc"){
          cssClass="fa-sort-asc";
        }else if(cssClassOrIconPath == "action-sort-desc"){
          cssClass="fa-sort-desc";
        }else if(cssClassOrIconPath == "action-update"){
          cssClass="fa-pencil";
        }else if(cssClassOrIconPath == "action-user-logout"){
          cssClass="fa-sign-out";
        }else if(cssClassOrIconPath == "action-user-trash") {
          cssClass ="fa-trash";
        }else if(cssClassOrIconPath == "action-export"){
          cssClass="fa-file-excel-o";
        }else if(cssClassOrIconPath == "action-cog"){
          cssClass="fa-cog";
        }else if(cssClassOrIconPath == "action-menuBar"){
          cssClass="fa-angle-double-down";
        }else if(cssClassOrIconPath == "action-publish"){
          cssClass="fa-paper-plane";
        }else if(cssClassOrIconPath == "action-view"){
          cssClass="fa-eye";
        }else if(cssClassOrIconPath == "action-report"){
          cssClass="fa-pie-chart";
        }else if(cssClassOrIconPath == "action-submit"){
          cssClass="fa-hand-o-up";
        }else if(cssClassOrIconPath == "action-cancel"){
          cssClass="fa-undo";
        }else if(cssClassOrIconPath == "action-back"){
          cssClass="fa-reply";
        }else if(cssClassOrIconPath == "action-audit"){
          cssClass="fa-key";
        }

        else if(cssClassOrIconPath == "action-menu"){
          // \u53bb\u9664\u9875\u9762title\u524d\u7684\u56fe\u6807zn
          // cssClass ="fa-list-alt";
          cssClass ="";
        }else if (cssClassOrIconPath != undefined && cssClassOrIconPath.indexOf("fa")<0){
          return '<span class="toolbar-icon ' + cssClassOrIconPath + '" ></span>';
        }else if (cssClassOrIconPath == undefined) {
          cssClass = "";
        }else if(cssClassOrIconPath.indexOf("fa")>=0){
          cssClass = cssClassOrIconPath;
        }
      }
        if(cssClass == ""){
          return "";
        }else{
          return '<span class="toolbar-icon-new fa ' + cssClass + '" ></span>';
        }
    }
    /**
     * \u8bbe\u7f6e\u6309\u94ae\u7684\u52a8\u4f5c
     */
    function setAction(item,action){
      if(null==action){
        bg.alert("action should not be null");
        return;
      }
      if(typeof action=='function'){
        item.onclick=action;
        return;
      }
      if(typeof action=='string'){
        if (action.indexOf('(')!=-1){
          item.onclick= function (){eval(action);}
        }
        else if(action.indexOf('.action')!=-1){
          item.onclick=function (){Go(action)}
        }else{
          bg.alert("unsuported action description:"+action);
        }
      }
      if(typeof action=='object'){
        item.onclick=action.func;
        return;
      }
    }

    this.addBack = function (title){
      if(null==title){
        this.addItem(bg.i18n("back"),function (){history.back(-1)},'fa-angle-left');
      }else{
        this.addItem(title,function (){history.back(-1)},'fa-angle-left');
      }
    }
    this.addHelp = function (module){
      this.addItem(bg.i18n("help"),function (){
        if(null==module) bg.alert(bg.i18n("under.construction"));
        else window.open("help.action?helpId="+module);
      },'fa-question-circle-o');
    }

    this.addPrint = function (msg){
      if(null==msg) this.addItem(bg.i18n("print"),"print()");
      else this.addItem(msg,"print()");
    }

    this.addClose = function (msg){
      if(''==msg|| null==msg)  msg=bg.i18n("close");
      this.addItem(msg,"window.close()",'fa-close');
    }


    /**
     * \u6dfb\u52a0\u6309\u94ae \u6839\u636e\u6309\u94aecode\u8fa8\u522b\u662f\u5426\u6709\u6743\u9650
     * @param btnCode
     * @param title
     * @param action
     * @param imageName
     * @param alt
     * @param objectCount
     * @returns {*}
     */
    this.addNewItem = function(btnCode,title,action,imageName,alt,objectCount){
      var flag = false;
      if( securityButtons && securityButtons != "" && securityButtons != undefined) {
        jQuery.each(securityButtons, function (i, button) {
          if(button.code == '*' || button.code == btnCode){
            flag = true;
            return;
          }
        });
        if(!flag){
          return ;
        }
      }
      //\u4e0b\u9762\u8ddfaddItem \u4fdd\u6301\u4e00\u81f4
      this.addSeparatorAsNeed();
      var item_div = document.createElement('div');
      item_div.innerHTML=genIconElement(action,imageName)+title;
      item_div.onmouseout=MouseOutItem;
      item_div.onmouseover=MouseOverItem;
      setAction(item_div,action);
      if(!objectCount) { if(typeof action=='object'){objectCount=action.objectCount;}}
      if(!objectCount) objectCount='ge0';
      item_div.className=("btn btn-default toolbar-item toolbar-item-"+objectCount) + ((objectCount!='ge0')?" toolbar-item-disabled":"");
      item_div.title=(alt==null?title:alt);
      this.items_div.appendChild(item_div);
      this.itemCount++;
      return item_div;
    }
    /**
     * \u6dfb\u52a0\u6309\u94ae
     */
    this.addItem = function(title,action,imageName,alt,objectCount){
      var flag = false;
      if(title!='\u8fd4\u56de' && title!='\u5173\u95ed'&& securityButtons && securityButtons != "" && securityButtons != undefined) {
        jQuery.each(securityButtons, function (i, button) {
          if(button.name == '*' || button.name == title){
            flag = true;
            return;
          }
        });
        if(!flag){
          return ;
        }
      }
      
      this.addSeparatorAsNeed();
      var item_div = document.createElement('div');
      // \u5c06\u3010\u8fd4\u56de\u3011\u6309\u94ae\u4e0e\u9875\u9762\u5176\u4ed6\u6309\u94ae\u62c6\u5f00\uff0c\u548ctitle\u653e\u5728\u4e00\u4e2adiv\u4e2dzn
      if (title == '\u8fd4\u56de' || title == '\u9000\u56de' || title == '\u540e\u9000') {
      	item_div.innerHTML="";
      	setAction(item_div,action);
      	item_div.className=("toolBackBtn");
      	item_div.title=(alt==null?title:alt);
      	this.title_div.prepend(item_div);
      } else {
	      item_div.innerHTML=genIconElement(action,imageName)+title;
	      item_div.onmouseout=MouseOutItem;
	      item_div.onmouseover=MouseOverItem;
	      setAction(item_div,action);
	      if(!objectCount) { if(typeof action=='object'){objectCount=action.objectCount;}}
	      if(!objectCount) objectCount='ge0';
	      item_div.className=("btn btn-default toolbar-item toolbar-item-"+objectCount) + ((objectCount!='ge0')?" toolbar-item-disabled":"");
	      item_div.title=(alt==null?title:alt);
	      this.items_div.appendChild(item_div);
      }
      
      this.itemCount++;
      return item_div;
    }
    this.addDiv=function(className){
      var newDiv = document.createElement('div');
      if(className)newDiv.className=className;
      this.items_div.appendChild(newDiv);
      return newDiv;
    }
    this.appendDiv=function(id,className){
      var newDiv = document.createElement('div');
      if(id)newDiv.setAttribute("id",id);
      if(className)newDiv.className=className;
      document.getElementById(this.id).appendChild(newDiv);
      return newDiv;
    }
    /**
     * \u6dfb\u52a0\u5206\u9694\u7b26
     *
     */
    this.addSeparator = function (){
      if(this.separator){
        this.addDiv("toolbar-separator").innerHTML=this.separator;
      }
    }

    this.addSeparatorAsNeed = function (){
      if(this.itemCount!=0){
        this.addSeparator();
      }
    }
    this.addBackOrClose = function (backCaption, closeCaption) {
      if (parent.location == self.location && (window.history.length <= 1 || window.history.length == null)) {
        this.addClose((null == closeCaption) ? bg.i18n("close") : closeCaption);
      } else {
        this.addBack((null == backCaption) ? bg.i18n("back") : backCaption);
      }
    }
    // \u589e\u52a0\u7a7a\u767d\u529f\u80fd\u70b9
    this.addBlankItem = function () {
      this.addDiv("toolbar-group-separator").innerHTML="&nbsp;";
      this.itemCount++;
    }
    /**
     * \u8bbe\u7f6e\u5de5\u5177\u680f\u7684\u6d88\u606f\u533a
     *
     */
    this.setMessage = function (msg){
      if (typeof msg == "undefined") return;
      document.getElementById(this.id+"_msg").innerHTML=msg;
    }

    this.addColMenu = function(imageName,alt){
      var item_div = document.createElement('div');
      item_div.className="toolbar-item btn btn-default";
      item_div.style="margin-right:20px;";
      var menuTableId=this.id+this.itemCount+"_menu";
      item_div.id=menuTableId;
      item_div.tabIndex = 0;
      item_div.title=alt||title;
      item_div.onmouseout=MouseOutItem;
      item_div.onmouseover=MouseOverItem;
      this.items_div.appendChild(item_div);

      item_div.innerHTML=genIconElement(null,imageName) + '&nbsp;'+ genIconElement(null,'action-downarrow');
      item_div.onclick=function (event){displayMenu(event);};
      item_div.onblur = function (event){
        var className = jQuery(event.currentTarget)[0].getAttribute('class');
        if(className.indexOf('toolbar-item-transfer') >= 0){
          item_div.focus();
          return;
        }
        hiddenMenu(event);
      };
      var menu = new Menu(menuTableId,item_div);
      this.itemCount++;
      return menu;
    }

    /**
     * \u5728\u5de5\u5177\u680f\u4e2d\u6dfb\u52a0\u4e00\u4e2a\u83dc\u5355
     */
    this.addMenu = function(title,action,imageName,alt){
      var flag = false;
      if( securityButtons && securityButtons != "" && securityButtons != undefined) {
        jQuery.each(securityButtons, function (i, button) {
          if(button.name == '*' || button.name == title){
            flag = true;
            return;
          }
        });
        if(!flag){
          return  new Menu(null,null);
        }
      }
      this.addSeparatorAsNeed();
      var item_div = document.createElement('div');
      item_div.className="toolbar-item btn btn-default";
      var menuTableId=this.id+this.itemCount+"_menu";
      item_div.id=menuTableId;
      item_div.tabIndex = 0;
      item_div.title=alt||title;
      item_div.onmouseout=MouseOutItem;
      item_div.onmouseover=MouseOverItem;
      this.items_div.appendChild(item_div);

      if(action == null){
        item_div.innerHTML=genIconElement(null,imageName) + title + '&nbsp;'+ genIconElement(null,'action-downarrow');
        item_div.onclick=function (event){displayMenu(event);};
      }else{
        var span1 = document.createElement("span");
        span1.innerHTML=genIconElement(action,imageName)+title;
        setAction(span1,action);
        var span2 = document.createElement("span");
        span2.innerHTML=genIconElement(action,"action-downarrow");
        span2.onclick = function (event){displayMenu(event);};
        item_div.appendChild(span1);
        item_div.appendChild(span2);
      }
      item_div.onblur = function (event){
        var className = jQuery(event.currentTarget)[0].getAttribute('class');
        if(className.indexOf('toolbar-item-transfer') >= 0){
          item_div.focus();
          return;
        }
        hiddenMenu(event);
      };
      var menu = new Menu(menuTableId,item_div);
      this.itemCount++;
      return menu;
    }

    function hiddenMenu(event){
      var div=bg.event.getTarget(event);
      while(div && div.tagName.toLowerCase()!='div'){
        div=div.parentNode;
      }
      var menu=div.lastElementChild || div.lastChild;
      if(null==menu || menu.tagName.toLowerCase()!='table'){alert('menu is null then return and target is '+div);return;}
      if(menu.style.visibility!=""&&menu.style.visibility!="hidden"){
        for(var i = 0;i < menu.rows.length;i++){
          if(menu.rows[i].cells[0].className=='toolbar-menuitem-transfer'){
            return;
          }
        }
        menu.style.visibility="hidden";
      }
    }

    function displayMenu(event){
      var div=bg.event.getTarget(event);
      while(div && div.tagName.toLowerCase()!='div'){
        div=div.parentNode;
      }
      var menu=div.lastElementChild || div.lastChild;
      if(null==menu){alert('menu is null then return and target is '+div);return;}
      if(menu.style.visibility!=""&&menu.style.visibility!="hidden"){
        menu.style.visibility="hidden";
        div.className="toolbar-item-transfer btn btn-default";
      }else{
        menu.style.visibility="visible";
        div.className="toolbar-item-selected btn btn-default";
      }
    }
    /**
     * \u751f\u6210\u4e00\u4e2a\u83dc\u5355
     */
    function Menu(id,item_div){
      if(id != null){
        var table=document.createElement("table");
        table.className="toolbar-menu";
        table.id=id+"Table";
        var mytablebody = document.createElement("tbody");
        table.appendChild(mytablebody);
        if (jQuery("#" + id).find("span").length>0) {
          table.onclick = function (event){displayMenu(event);};
        }
        item_div.appendChild(table);
        this.table=table;
      }

      /**
       * \u5728\u83dc\u5355\u4e2d\u6dfb\u52a0\u4e00\u4e2a\u6761\u76ee----\u6839\u636e\u6309\u94ae\u4ee3\u7801\u63a7\u5236\u6743\u9650 \u9488\u5bf9\u91cd\u540d\u7684\u6309\u94ae
       */
      this.addNewItem = function (btnCode,title,action,imageName,alt){
        if(id == null){
          return;
        }
        // var flag = false;
        // if( securityButtons && securityButtons != "" && securityButtons != undefined) {
        //   jQuery.each(securityButtons, function (i, button) {
        //     if(button.name == '*' || button.name == title){
        //       flag = true;
        //       return;
        //     }
        //   });
        //   if(!flag){
        //     return ;
        //   }
        // }
        var flag = false;
        if( securityButtons && securityButtons != "" && securityButtons != undefined) {
          jQuery.each(securityButtons, function (i, button) {
            if(button.code == '*' || button.code == btnCode){
              flag = true;
              return;
            }
          });
          if(!flag){
            return ;
          }

        }

        var itemTd = document.createElement('td');
        itemTd.innerHTML=genIconElement(action,imageName)+title;
        itemTd.onmouseout=MouseOutMenuItem;
        itemTd.onmouseover=MouseOverMenuItem;
        itemTd.title=alt||title;
        setAction(itemTd,action);
        itemTd.className="toolbar-menuitem btn btn-default";
        itemTd.width="100%";
        var tr = document.createElement('tr');
        tr.appendChild(itemTd);
        if(this.table.tBodies.length==0) this.table.appendChild(document.createElement("tbody"));
        this.table.tBodies[0].appendChild(tr);
      }

      /**
       * \u5728\u83dc\u5355\u4e2d\u6dfb\u52a0\u4e00\u4e2a\u6761\u76ee
       */
      this.addItem = function (title,action,imageName,alt){
        if(id == null){
          return;
        }
        var flag = false;
        if( title!='\u8fd4\u56de' && securityButtons && securityButtons != "" && securityButtons != undefined) {
          jQuery.each(securityButtons, function (i, button) {
            if(button.name == '*' || button.name == title){
              flag = true;
              return;
            }
          });
          if(!flag){
            return ;
          }
        }
        var itemTd = document.createElement('td');
        itemTd.innerHTML=genIconElement(action,imageName)+title;
        itemTd.onmouseout=MouseOutMenuItem;
        itemTd.onmouseover=MouseOverMenuItem;
        itemTd.title=alt||title;
        setAction(itemTd,action);
        itemTd.className="toolbar-menuitem btn btn-default";
        itemTd.width="100%";
        var tr = document.createElement('tr');
        tr.appendChild(itemTd);
        if(this.table.tBodies.length==0) this.table.appendChild(document.createElement("tbody"));
        this.table.tBodies[0].appendChild(tr);
      }

      this.addCheckboxItem = function(title,name,action,checked,alt){
        var itemTd = document.createElement('td');
        itemTd.onmouseout=MouseOutMenuItem;
        itemTd.onmouseover=MouseOverMenuItem;
        itemTd.title=alt||title;
        var checkItem = document.createElement("input");
        checkItem.type="checkbox";
        checkItem.value=name;
        checkItem.name="displayCol";
        setAction(itemTd,action);
        itemTd.appendChild(checkItem);
        itemTd.innerHTML = itemTd.innerHTML + "&nbsp" + title;
        itemTd.className="toolbar-menuitem btn btn-default";
        itemTd.width="150px";
        var tr = this.table.tBodies[0].lastChild;
        if (tr != null){
          var flag = false;
          jQuery(tr).children().each(function () {
            if (jQuery(this).children().length == 0){
              jQuery(this).before(itemTd);
              jQuery(this).remove();
              flag = true;
              return false;
            }
          });
          if (!flag){
            var tr = document.createElement('tr');
            tr.appendChild(itemTd);
            var itemTd1 = document.createElement('td');
            itemTd1.className="toolbar-menuitem btn btn-default";
            itemTd1.width="150px";
            var itemTd2 = document.createElement('td');
            itemTd2.className="toolbar-menuitem btn btn-default";
            itemTd2.width="150px";
            tr.appendChild(itemTd1);
            tr.appendChild(itemTd2);
            this.table.tBodies[0].appendChild(tr);
          }
        }else{
          var tr = document.createElement('tr');
          tr.appendChild(itemTd);
          tr.appendChild(document.createElement('td'));
          tr.appendChild(document.createElement('td'));
          if(this.table.tBodies.length==0) this.table.appendChild(document.createElement("tbody"));
          this.table.tBodies[0].appendChild(tr);
        }
        jQuery(this.table.tBodies[0]).find("input[value='" + name + "']").prop("checked", checked);
        jQuery(this.table.tBodies[0]).find("input[value='" + name + "']").click(function (event) {
          jQuery(this).parent().addClass("clicked");
          jQuery(this).parent().click();
          jQuery(this).parent().removeClass("clicked");
          event.stopPropagation();
        });
      }
    }

    // /\u83dc\u5355\u6761\u76ee\u7684\u9f20\u6807\u8fdb\u5165\u548c\u79bb\u5f00\u4e8b\u4ef6\u54cd\u5e94\u65b9\u6cd5
    function MouseOutMenuItem(e){
      var o=bg.event.getTarget(e);
      while (o && o.tagName.toLowerCase()!="td"){o=o.parentNode;}
      if(o)o.className="toolbar-menuitem btn btn-default";
    }

    function MouseOverMenuItem(e){
      var o=bg.event.getTarget(e);
      while (o && o.tagName.toLowerCase()!="td"){o=o.parentNode;}
      if(o)o.className="toolbar-menuitem-transfer btn btn-default";
    }
    /**
     * \u5f53\u9f20\u6807\u7ecf\u8fc7\u5de5\u5177\u680f\u7684\u6309\u94ae\u65f6
     *
     */
    function MouseOverItem(e){
      var o=bg.event.getTarget(e);
      while (o&&o.tagName.toLowerCase()!="div"){o=o.parentNode;}
      if(o) jQuery(o).removeClass("toolbar-item").addClass("toolbar-item-transfer btn btn-default");
    }
    /**
     * \u5f53\u9f20\u6807\u79bb\u5f00\u5de5\u5177\u680f\u7684\u6309\u94ae\u65f6
     */
    function MouseOutItem(e){
      var o=bg.event.getTarget(e);
      while (o&&o.tagName.toLowerCase()!="div"){o=o.parentNode;}
      if(o) jQuery(o).removeClass("toolbar-item-transfer").removeClass("toolbar-item-selected").addClass("toolbar-item btn btn-default");
    }
  }

  	function getActionName(path){
  		// \u5f97\u5230\u5f53\u524daction\u540d
        var form = document.forms[0];
        var url = "";
        if (form != null) {
          url = form.action;
          url = url.substring(url.lastIndexOf(path)+path.toString().length);
          url = url.indexOf('!') == -1 ? url.substring(0, url.indexOf('.action')) : url.substring(0, url.indexOf('!'));
        }else if(url == "") {
          var urlProfile = window.location.pathname.split("/")[1];
          url = window.location.pathname.substring(urlProfile.length+1,window.location.pathname.indexOf("!"));
          if(window.location.pathname.indexOf("!") == -1) {
            url = window.location.pathname.substring(urlProfile.length+1,window.location.pathname.indexOf(".action"));
          }
        }
        return url;
  	}
  	 /**
  	  *\u901a\u8fc7action\u83b7\u53d6\u5bf9\u5e94\u83dc\u5355\u4e0b\u7684\u6309\u94ae
  	  */
     function getSecurityButtons(bar_url, path){
       var securityButtons = null;
       try{
         jQuery.ajax({
           async:false,
           type:"post",
           url:path+"/security/button-security.action",
           data:{
             "funcResource":bar_url
           },
           error:function(){},
           success: function(datas) {
             isHideMenu = true;
             var obj = eval("(" + datas + ")");
             if(obj.buttons == "") {
               return ;
             }
             securityButtons  = obj.buttons;
           }
         });
       }catch (e) {
       }
       return securityButtons;
     }

  bg.extend({'ui.toolbar':function (divId,title,imageName,securityButtons){
      if(securityButtons == undefined){
        var toolbar_url = getActionName(beangle.getContextPath());
        securityButtons = getSecurityButtons(toolbar_url, beangle.getContextPath());
      }
      return new ToolBar(divId,title,imageName,securityButtons);
    }
  });

  bg.extend({'ui.gridbar':function(divIds,title){
      this.divIds=divIds;
      this.pageId=null;
      this.title=title;
      this.toolbars=[];
      for(var i=0;i<divIds.length;i++){
        this.toolbars[i]=bg.ui.toolbar(divIds[i],title);
        this.toolbars[i].setSeparator("");
        document.getElementById(divIds[i]).className="gridbar";
        document.getElementById(divIds[i]+"_items").className="gridbar-items btn-group-sm";
      }
      this.pageId=function(givenId){
        this.pageId=givenId;
        return this;
      }
      this.addItem=function(title,action,imageName,alt){
        for(var i=0;i<this.toolbars.length;i++){
          this.toolbars[i].addItem(title,action,imageName,alt);
        }
      }
      this.addNewItem=function(btnCode,title,action,imageName,alt){
        for(var i=0;i<this.toolbars.length;i++){
          this.toolbars[i].addNewItem(btnCode,title,action,imageName,alt);
        }
      }
      this.addBack=function(title,action){
        for(var i=0;i<this.toolbars.length;i++){
          this.toolbars[i].addBack(title);
        }
      }
      this.addBackOrClose=function(){
        for(var i=0;i<this.toolbars.length;i++){
          this.toolbars[i].addBackOrClose();
        }
      }
      this.addBlankItem=function(title,action,imageName,alt){
        for(var i=0;i<this.toolbars.length;i++){
          this.toolbars[i].addBlankItem(title,action,imageName,alt);
        }
      }
      this.addPage=function(onePage,ranks,titles){
        this.myPage=onePage;
        for(var i=0;i<this.toolbars.length;i++){
          pageDiv=this.toolbars[i].appendDiv(divIds[i]+'_page',"girdbar-pgbar");
          
          //yy:add
          var msg_div = document.createElement('div');
      	  msg_div.className="toolbar-msg";
      	  msg_div.style.display="none";
      	  msg_div.id=divIds[i]+"_msg";
      	  pageDiv.appendChild(msg_div);
      
          bg.ui.pagebar(onePage,pageDiv,ranks,titles);
          jQuery(".pgbar-selbox").chosen();
        }
        return this;
      }
      this.addEntityAction=function(entity,onePage){
        return new bg.entityaction(entity,onePage);
      }
      this.addPrint=function(msg){
        for(var i=0;i<this.toolbars.length;i++){
          this.toolbars[i].addPrint(msg);
        }
      }

      function colMenus(imageName, alt, bars){
        var menu = new Array();
        for(var i=0;i<bars.length;i++){
          menu[i] = bars[i].addColMenu(imageName,alt);
        }
        this.addCheckboxItem= function (title,name,action,checked,alt){
          for(var i=0;i<menu.length;i++){
            menu[i].addCheckboxItem(title,name,action,checked,alt);
          }
        }
      }
      this.addColMenu=function(imageName,alt){
        return new colMenus(imageName, alt, this.toolbars);
      }
      this.addMenu=function(title,action,imageName,alt){
        return new menus(title,action,imageName,alt,this.toolbars);
      }
      function menus(title,action,imageName,alt,bars){
        var menu = new Array();
        for(var i=0;i<bars.length;i++){
          menu[i] = bars[i].addMenu(title,action,imageName,alt);
        }
        this.addItem = function (title,action,imageName,alt){
          for(var i=0;i<menu.length;i++){
            menu[i].addItem(title,action,imageName,alt)
          }
        }
        this.addNewItem = function (btnCode,title,action,imageName,alt){
          for(var i=0;i<menu.length;i++){
            menu[i].addNewItem(btnCode,title,action,imageName,alt)
          }
        }
      }
    }});

	//yy:\u6539\u9020\u6b64\u65b9\u6cd5\uff0c\u4e3a\u4e86\u8c03\u8bd5\u5206\u9875\u7684\u6837\u5f0f
  bg.extend({'ui.pagebar':function (onePage,pageDiv,ranks,titles){
      if(onePage.total==0) return;

      if(!ranks) ranks=[10,20,30,50,70,100,200,500,1000];
      else if(ranks.length==0) ranks=[onePage.pageSize];


      if(!titles) titles={first:'\u00ab',previous:'\u2039',next:'\u203a',last:'\u00bb',no:'No:',size:'Size:',change:'Click me to change page size',pagesize:'Page Size'};
      var maxPageNo = onePage.maxPageNo;
      addAnchor=function(text,pageNumber){
        /*	var pageHref=document.createElement('a');
        pageHref.setAttribute("href","javascript:void(0)");
        pageHref.innerHTML=text;
        pageHref.style.padding="0px 2px 0px 2px";
        pageDiv.appendChild(pageHref);
        jQuery(pageHref).click(function(){onePage.goPage(pageNumber)});
        */
        var pageHref=document.createElement('button');
        pageHref.setAttribute("type","button");
        pageHref.className="btn btn-default";
        pageHref.style.padding="4px";
        pageHref.style.height="24px";
        if(text == "first"){
	        var firstIcon=document.createElement('i');
	      	firstIcon.className="fa fa-angle-double-left";
	      	pageHref.appendChild(firstIcon);
        }else if(text == "previous"){
	        var firstIcon=document.createElement('i');
	      	firstIcon.className="fa fa-angle-left";
	      	pageHref.appendChild(firstIcon);
        }else if(text == "next"){
	        var firstIcon=document.createElement('i');
	      	firstIcon.className="fa fa-angle-right";
	      	pageHref.appendChild(firstIcon);
        }else if(text == "last"){
	        var firstIcon=document.createElement('i');
	      	firstIcon.className="fa fa-angle-double-right";
	      	pageHref.appendChild(firstIcon);
        }
        pageDiv.appendChild(pageHref);
        jQuery(pageHref).click(function(){onePage.goPage(pageNumber)});
      }
      if(onePage.pageNo>1){
        //addAnchor(titles['first'],1);
        //addAnchor(titles['previous'],onePage.pageNo-1);
         addAnchor('first',1);
         addAnchor('previous',onePage.pageNo-1);
      }
      
      var labelspanDiv=document.createElement('div');
      labelspanDiv.className="btn btn-default pgbar-button-div";
      labelspanDiv.style.padding="2px 8px";
      labelspanDiv.style.margin="10px 4px";
      labelspanDiv.style.fontSize="12px";
      labelspanDiv.style.height="24px";
      
      var labelspan=document.createElement('span');
      labelspan.innerHTML="<span>" + onePage.startNo +"</span> - <span>"+ onePage.endNo + "</span> of <span>" + onePage.total + "</span>";
      labelspan.style.padding="0px 2px 0px 2px";
      labelspanDiv.appendChild(labelspan);
      pageDiv.appendChild(labelspanDiv);
      //pageDiv.appendChild(labelspan);
      var numSpan=jQuery(labelspan)
      numSpan.attr('title',titles['change'])
      numSpan.mouseover(function (){this.className='pgbar-label'});
      numSpan.mouseout(function(){this.className=''});
      // \u4e3a\u4e86\u9632\u6b62\u5176\u4ed6\u4fe1\u606f\u4e0a\u4e0b\u79fb\u52a8\u9519\u8bef
      numSpan.click(function(){
	      this.parentNode.style.marginTop="0px";
	      //this.nextSibling.style.display='';
	      this.parentNode.nextSibling.style.display='';
	      this.style.display='none';
	      this.parentNode.style.display='none';
	      });

      var pagespan=document.createElement('span');
      pagespan.style.display="none";
      //add pagesize select
      var pageNoSelect;
      if(ranks && (ranks.length>0)){
        pageNoSelect=document.createElement('select');
        pageNoSelect.id=pageDiv.id+"_select";
        pagespan.appendChild(pageNoSelect);
        pageNoSelect.className="pgbar-selbox";
        pageNoSelect.title=titles['pagesize']||'Page Size';
        var selectIndex=0;
        for(var i=0;i<ranks.length;i++){
          if(ranks[i]==onePage.pageSize) selectIndex=i;
          pageNoSelect.options.add(new Option(titles['size']+ranks[i], ranks[i]));
        }
        pageNoSelect.selectedIndex = selectIndex;
      }

      //add pageno input
      var pageInput=document.createElement('input');
      pageInput.className="pgbar-input";
      pagespan.appendChild(pageInput);

      var pageInputLabel = document.createElement('label');
      pagespan.appendChild(pageInputLabel);

      jQuery(pageInputLabel).attr("for",pageDiv.id+"_input").text("/"+maxPageNo+" ").toggleClass("pgbar-input-label");

      var pageInputJ=jQuery(pageInput)
      pageInputJ.attr("value",onePage.pageNo);
      pageInputJ.attr("id",pageDiv.id+"_input");
      pageInputJ.attr('title',(onePage.startNo +" - " + onePage.endNo + " of " + onePage.total));
      pageInputJ.focus(function(){this.value=''});
      pageInputJ.blur(function(){if(!this.value) this.value= onePage.pageNo});

      //add go button
      var submitBtn = document.createElement('input');
      submitBtn.setAttribute("type",'button');
      submitBtn.setAttribute("name",'gogo');
      submitBtn.value="Go"
      submitBtn.className="pgbar-go";
      pagespan.appendChild(submitBtn);
      var changePage=function(){
        var pageNo=document.getElementById(pageDiv.id+'_input').value;var endIndex=pageNo.indexOf("/"+onePage.maxPageNo);
        if(-1!=endIndex){pageNo=pageNo.substring(0,endIndex)}
        onePage.goPage(pageNo,document.getElementById(pageDiv.id+'_select').value);
      }
      jQuery(submitBtn).click(function (){changePage()});
      // \u9009\u62e9\u6761\u6570\u540e\u76f4\u63a5\u8df3\u8f6c
	  jQuery(pageNoSelect).change(function (){changePage()});
      pageDiv.appendChild(pagespan);
      jQuery(pagespan).keypress(function(event){
        if (!event) {event = window.event;}
        if (event && event.keyCode && event.keyCode == 13) {changePage();return false;}
      });

      if(onePage.pageNo<onePage.maxPageNo){
        //addAnchor(titles['next'],onePage.pageNo+1);
        //addAnchor(titles['last'],onePage.maxPageNo);
        addAnchor('next',onePage.pageNo+1);
        addAnchor('last',onePage.maxPageNo);
      }
    }
  });
  bg.extend({
    'ui.grid':{
      enableSingleRowSelect : false,
      enableDynaBar:false,
      enableSelectTip:true,
      // \u9f20\u6807\u7ecf\u8fc7\u548c\u79fb\u51fa\u6392\u5e8f\u8868\u683c\u7684\u8868\u5934\u65f6
      overSortTableHeader : function  (){
        this.style.color='white';
        this.style.backgroundColor ='green'
      },
      outSortTableHeader : function (){
        this.style.borderColor='';
        this.style.color='';
        this.style.backgroundColor ='';
      },
      // \u9f20\u6807\u7ecf\u8fc7\u6570\u636e\u884c\u7684\u6548\u679c
      mouseOverGrid : function (){
        if((typeof this.className)=="undefined") return;
        var myclass=this.className;
        selectIndex=myclass.indexOf("griddata-selected");
        if(-1 != selectIndex) return;
        overIndex=myclass.indexOf("griddata-over");
        if(-1 == overIndex){
          this.className=myclass+" "+ "griddata-over"
        }else{
          this.className=myclass.substring(0,overIndex);
        }
      },
      setGridMessage : function (gridId,message){
        var msgDiv1=document.getElementById(gridId+'_bar1_msg');
        var msgDiv2=document.getElementById(gridId+'_bar2_msg');
        if(msgDiv1){
          msgDiv1.style.display=(message?"":"none");
          msgDiv1.innerHTML=(message?message:"");
        }
        if(msgDiv2){
          msgDiv2.style.display=(message?"":"none");
          msgDiv2.innerHTML=(message?message:"");
        }
      },
      toggleAll : function(event){
        var ele =  bg.event.getTarget(event);
        //find fired grid table
        var ownGridTable=ele;
        while(ownGridTable.tagName != null && ownGridTable.tagName.toLowerCase()!="table"){
          ownGridTable=ownGridTable.parentNode;
          if(null==ownGridTable) break;
        }
        var firstCell=ele.parentNode;

        if(null==ownGridTable) return;
        var selectedCount=0;
        jQuery("#"+ownGridTable.id + " .gridselect").each(function(){
          var inputs=jQuery(this).find("input");
          if(inputs.length==0)return;
          if(ele.checked){
            inputs.prop("checked",true);
            jQuery(this).parent("tr").addClass("griddata-selected");
            selectedCount++;
          }else{
            if(inputs.is(":checked")){
              inputs.prop("checked",false);
              jQuery(this).parent("tr").removeClass("griddata-selected");
            }
          }
        });
        bg.ui.grid.notifyGridbar(ownGridTable.id,selectedCount);
      },
      /**\u901a\u77e5gridbar\u4e2d\u7684\u6309\u94ae,\u66f4\u65b0\u662f\u5426\u663e\u793a\u7b49\u72b6\u6001*/
      notifyGridbar: function (gridId,selectedCount){
        //change toolbar item
        var changeToolbarItem=function(){
          if(selectedCount>=2) {
            if(jQuery(this).hasClass("toolbar-item-e1")) jQuery(this).addClass('toolbar-item-disabled');
            else jQuery(this).removeClass('toolbar-item-disabled');
          } else if(selectedCount==1) {
            if(jQuery(this).hasClass("toolbar-item-ge2"))  jQuery(this).addClass('toolbar-item-disabled');
            else jQuery(this).removeClass('toolbar-item-disabled');
          } else{
            if(jQuery(this).hasClass("toolbar-item-ge0"))  jQuery(this).removeClass('toolbar-item-disabled');
            else jQuery(this).addClass('toolbar-item-disabled');
          }
        };
        if(bg.ui.grid.enableDynaBar){
          jQuery('#'+gridId+'_bar1_items .toolbar-item').each(changeToolbarItem);
          jQuery('#'+gridId+'_bar2_items .toolbar-item').each(changeToolbarItem);
        }
        //yy:edit
        if(bg.ui.grid.enableSelectTip){
          if(selectedCount>0) bg.ui.grid.setGridMessage(gridId,bg.i18n('selected') + " <span class='text-primary'>"+selectedCount+"</span> " + bg.i18n("item.amount.pl"));
          else  bg.ui.grid.setGridMessage(gridId,"");
        }
      },
      /**
       * \u884c\u9009\u51fd\u6570\u3002\u5355\u51fb\u884c\u5185\u7684\u4efb\u4e00\u5904\uff0c\u53ef\u4ee5\u9009\u5b9a\u884c\u5934\u7684checkbox\u6216\u8005radio \u7528\u6cd5:onclick="toggleRow(event)"
       */
      toggleRow : function (event){
        var ele =  bg.event.getTarget(event);
        //find fired grid table
        var ownGridTable=ele;
        while(ownGridTable.tagName != null && ownGridTable.tagName.toLowerCase()!="table"){
          ownGridTable=ownGridTable.parentNode;
          if(null==ownGridTable) break;
        }
        var changed=true;
        var firstCell=null;
        var isFireOnBoxCell=false;
        if(null!=ele && ele.tagName.toLowerCase()=="td"){
          firstCell = ele.parentNode.firstChild;
          //find first cell
          while(firstCell.tagName == null || firstCell.tagName.toLowerCase()!="td"){
            firstCell=firstCell.nextSibling;
          }
          isFireOnBoxCell=(ele==firstCell);
          //shall we reserve other select
          // find box input
          ele=firstCell.firstChild;
          while(((typeof ele.tagName)=="undefined")||ele.tagName.toLowerCase()!="input"){
            ele=ele.nextSibling;
            if(ele==null)return;
          }
          ele.checked = !ele.checked;
        }else if((ele.type=="checkbox")||(ele.type=="radio")){
          firstCell=ele.parentNode;
          isFireOnBoxCell=true;
        }else{
          changed=false;
        }
        if(null==ele || null==firstCell || null==ownGridTable || !changed) return;

        // \u6539\u53d8\u9009\u5b9a\u884c\u7684\u989c\u8272
        var row=firstCell.parentNode;
        if((typeof row.className)=="undefined") return;
        if(ele.checked) jQuery(row).removeClass("griddata-over").addClass("griddata-selected");
        else jQuery(row).removeClass("griddata-selected").addClass("griddata-over");

        var selectedCount=0;
        if(ele.type=="radio") {
          if(ele.checked)  selectedCount=1;
        }else{
          var isReserveOtherSelect = !bg.ui.grid.enableSingleRowSelect || isFireOnBoxCell || event.ctrlKey ;
          jQuery("#"+ownGridTable.id + " .gridselect").each(function(){
            if(jQuery(this).find("input").is(":checked")){
              if(firstCell != this && !isReserveOtherSelect){
                jQuery(this).find("input").prop("checked",false);
                jQuery(this).parent("tr").removeClass("griddata-selected");
              }else{
                selectedCount++;
              }
            }
          });
          if(!isReserveOtherSelect){
            jQuery("#"+ownGridTable.id + " .gridselect-top").each(function(){
              jQuery(this).find("input").prop("checked",false);
            });
          }
        }

        bg.ui.grid.notifyGridbar(ownGridTable.id,selectedCount);
        // \u6fc0\u53d1\u81ea\u5b9a\u4e49\u4e8b\u4ef6
        if(typeof ele.onchange =="function") ele.onchange();
      },
      //\u5217\u6392\u5e8f\u5bf9\u5e94\u7684onePage\u548c\u9009\u4e2d\u7684\u5217
      sort : function (onePage,ele){
        if(null==onePage){
          bg.alert(bg.i18n("can.not.find.ordering.table"));return;
        }
        var orderByStr=null;
        if(ele.className=="gridhead-sortable"){
          if(typeof ele.asc!="undefined"){
            orderByStr=ele.asc;
          }
          else{
            orderByStr=ele.id+" asc";
          }
        }else if(ele.className=="gridhead-asc"){
          if(typeof ele.desc!="undefined"){
            orderByStr=ele.desc;
          }
          else{
            orderByStr=ele.id.replace(/\,/g," desc,")+" desc";
          }
        }else{
          orderByStr="";
        }
        onePage.goPage(1,null,orderByStr);
      },

      /**
       * \u521d\u59cb\u5316\u6392\u5e8f\u8868\u683c<br/>
       * \u6b64\u51fd\u6570\u4e3b\u8981\u662f\u5411\u5df2\u7ecf\u5f85\u6392\u5e8f\u8868\u683c\u7684\u5217\u59341)\u6dfb\u52a0\u9f20\u6807\u4e8b\u4ef6\u54cd\u5e94\u548c\u663e\u793a\u6548\u679c. 2)\u8d1f\u8d23\u5c06\u4e8b\u4ef6\u4f20\u9012\u5230\u7528\u6237\u5b9a\u4e49\u7684\u51fd\u6570\u4e2d.
       *
       * \u51e1\u662f\u8981\u6392\u5e8f\u7684\u5217,\u8bf7\u6ce8\u540d\u6392\u5e8f\u5355\u5143\u683c\u7684id \u548cclass. \u5176\u4e2did\u662f\u6392\u5e8f\u8981\u4f20\u9012\u7684\u5b57\u6bb5,class\u4e3a\u5b9a\u503cgridhead-kable.
       * \u9664\u6b64\u4e4b\u5916,\u7528\u6237(\u4f7f\u7528\u8be5\u65b9\u6cd5\u7684\u4eba)\u9700\u8981\u81ea\u5b9a\u4e49\u4e00\u4e2a\u94a9\u5b50\u51fd\u6570"sortBy(what)",\u4ee5\u5907\u8c03\u7528.
       *
       * @param tableId \u5f85\u6392\u5e8f\u8868\u683c\u7684id
       * @param onePage \u4e0e\u8868\u683c\u5bf9\u5e94\u7684page\u5bf9\u8c61
       */
      init : function (tableId,onePage){
        var table= document.getElementById(tableId), thead = table.tHead, tbody, orderBy, columnSort ,i ,j, head, row, cell, desc, asc, orignRowCls;
        if(!thead || thead.rows.length==0){
          //bg.alert("sortTable ["+tableId+"] without thead");
          return;
        }
        orderBy=onePage.orderby;
        columnSort = function(){// this is a td/th
          bg.ui.grid.sort(onePage,this);
        }
        for(j=0;j<thead.rows.length;j++){
          head=thead.rows[j];
          for(i=0;i<head.cells.length;i++){
            cell=head.cells[i];
            if(cell.className=="gridhead-sortable" && null!=cell.id){
              cell.onclick = columnSort;
              cell.onmouseover=bg.ui.grid.overSortTableHeader;
              cell.onmouseout=bg.ui.grid.outSortTableHeader;
              cell.title=bg.i18n("click.to.order.by1")+cell.innerHTML+bg.i18n("click.to.order.by2");
              desc=cell.id.replace(/\,/g," desc,")+" desc";
              if(typeof cell.desc !="undefined"){
                desc=cell.desc;
              }
               
              if(orderBy.indexOf(desc)!=-1){
                cell.className="gridhead-desc"
                cell.innerHTML=cell.innerHTML+'<span class="action-sort-desc"><svg aria-hidden="true" class="icon"><use xlink:href="#icon-list-sortdesc"></use></svg></span>'
                continue;
              }
              asc = cell.id+" asc";
              if(typeof cell.asc !="undefined"){
                asc = cell.asc;
              }
              if(orderBy==asc){
                cell.className="gridhead-asc"
                cell.innerHTML=cell.innerHTML+'<span class="action-sort-asc"><svg aria-hidden="true" class="icon"><use xlink:href="#icon-list-sortasc"></use></svg></span>'
                continue;
              }
              if(!(orderBy.indexOf(desc)!=-1 && orderBy==asc)){
              	cell.innerHTML=cell.innerHTML+'<span class="gridhead-icon"></span>'
              }
              
            }
          }
        }
        tbody=document.getElementById(tableId+"_data");
        if(!tbody)  return;
        for(j=0;j<tbody.rows.length;j++){
          row=tbody.rows[j];
          orignRowCls=row.className;
          if(orignRowCls){
            orignRowCls=" "+orignRowCls;
          }else{
            orignRowCls="";
          }
          if(j%2==1){
            row.className="griddata-odd" + orignRowCls;
          }else{
            row.className="griddata-even" + orignRowCls;
          }
          row.onclick = bg.ui.grid.toggleRow;
          row.onmouseover=bg.ui.grid.mouseOverGrid;
          row.onmouseout=bg.ui.grid.mouseOverGrid;
        }
      },
      fillEmpty : function (divId,pageSize,size,msg){
        var emptydiv=document.getElementById(divId), emptyCnt=pageSize-size, heightpx, emptyLabel;
        if(emptyCnt>7) emptyCnt=7;
        heightpx=emptyCnt*16;
        if(size==0){
          emptyLabel=document.createElement("div");
          emptyLabel.innerHTML=(msg||'No result matched your search.');
          emptyLabel.style.paddingTop=heightpx/2-16 +"px";
          emptydiv.appendChild(emptyLabel);
        }
        emptydiv.style.height=heightpx+"px";
      }
    }
  });

  // Action---------------------------------------------------------------------
  //this.action,this.paramstring,this.target
  function EntityAction(entity,onePage){
    this.entity=entity;
    this.page=onePage;
    this.formid="form_" + bg.randomInt();

    //record self for closure method
    var selfaction = this;

    function applyMethod(action,method){
      var last1=action.lastIndexOf("!"), lastDot=action.lastIndexOf("."), shortAction=action, sufix="";
      if(-1 == last1) last1 = lastDot;
      if(-1!=last1){
        shortAction=action.substring(0,last1);
      }
      if(-1!=lastDot){
        sufix=action.substring(lastDot);
      }
      return shortAction+"!"+method+sufix;
    }
    this.getForm=function (){
      return this.page.getForm();
    };
    this.addParam = function(name,value){
      bg.form.addInput(this.getForm(),name,value);
    }
    if(null!=this.page.target&&''!=this.page.target){
      var fm = this.getForm();
      if(null!=fm) fm.target=this.page.target;
    }

    this.beforeSubmmitId = function(method) {
      var ids = bg.input.getCheckBoxValues(entity+".id");
      if (ids == null || ids == "") {
        bg.alert(bg.i18n("no.item.selected"));
        return false;
      }
      var form=this.getForm();
      form.action = applyMethod(this.page.actionurl, method);
      if(this.page.paramstr){
        bg.form.addHiddens(form,this.page.paramstr);
        bg.form.addParamsInput(form,this.page.paramstr);
      }
      return true;
    }
    this.submitIdAction=function (method,multiId,confirmMsg,ajax){
      if (this.beforeSubmmitId(method)) {
        if(null!=confirmMsg && ''!=confirmMsg){
          //if(!confirm(confirmMsg))return;
          Swal.fire({
            title: confirmMsg,
            text: "请确定后操作",
            icon: 'warning',
            showCancelButton: true
          }).then((result) => {
            if (result.isConfirmed) {
              bg.form.submitId(this.getForm(),this.entity + ".id",multiId,null,null,ajax);

            }

          })

        }else{
          bg.form.submitId(this.getForm(),this.entity + ".id",multiId,null,null,ajax);
        }
      }
    }
    this.remove=function(confirmMsg){
      confirmMsg=confirmMsg||bg.i18n('confirm.delete');
      return new NamedFunction('remove',function(){
        selfaction.submitIdAction('remove',true,confirmMsg);
      },bg.ui.grid.enableDynaBar?'ge1':'ge0');
    }
    this.add = function(){
      return new NamedFunction('add',function(){
        var form=selfaction.getForm();
        if(""!=selfaction.page.paramstr) bg.form.addHiddens(form,selfaction.page.paramstr);
        bg.form.addInput(form,selfaction.entity + '.id',"");
        if(""!=selfaction.page.paramstr) bg.form.addParamsInput(form,selfaction.page.paramstr);
        bg.form.submit(form,applyMethod(selfaction.page.actionurl,"edit"));
      });
    }

    this.info = function(){
      return new NamedFunction('info',function(){
        selfaction.submitIdAction('info',false)
      },bg.ui.grid.enableDynaBar?'e1':'ge0');
    }

    this.edit = function (){
      return new NamedFunction('edit',function(){
        selfaction.submitIdAction('edit',false);
      },bg.ui.grid.enableDynaBar?'e1':'ge0');
    }

    this.single = function(methodName,confirmMsg,extparams){
      return new NamedFunction(methodName,function(){
        var form=selfaction.getForm();
        if(null!=extparams) bg.form.addHiddens(form,extparams);
        selfaction.submitIdAction(methodName,false,confirmMsg);
      },bg.ui.grid.enableDynaBar?'e1':'ge0');
    }

    this.multi = function(methodName,confirmMsg,extparams,ajax){
      return new NamedFunction(methodName,function(){
        try {
          var form = selfaction.getForm();
          if(null!=extparams) bg.form.addHiddens(form, extparams);
          selfaction.submitIdAction(methodName, true, confirmMsg,ajax);
        }catch(e){
          bg.alert(e)
        }
      },bg.ui.grid.enableDynaBar?'ge1':'ge0');
    }
    this.method=function(methodName,confirmMsg,extparams,ajax){
      return  new NamedFunction(methodName,function(){
        var form=selfaction.getForm();
        if(null!=confirmMsg && ''!=confirmMsg){
          if(!confirm(confirmMsg))return;
        }
        if(null!=extparams){
          bg.form.addHiddens(form,extparams);
        }
        if(""!=selfaction.page.paramstr){
          bg.form.addHiddens(form,selfaction.page.paramstr);
          bg.form.addParamsInput(form,selfaction.page.paramstr);
        }
        bg.form.submit(form,applyMethod(selfaction.page.actionurl ,methodName),null,null,ajax);
      });
    }

    this.exportData=function(properties,format,extparams){
      format = format || "xls";
      properties = properties||"";
      extparams = extparams||"";
      if(extparams.indexOf("&") != 0) extparams = "&" + extparams;
      extparams = "&format=" + format +"&properties=" + properties + extparams;
      return selfaction.method('export',null,extparams,false);
    }
  }

  bg.extend({entityaction:EntityAction});

  bg.extend({'ui.module':{
      moduleClick:function (moudleId){
        var id= document.getElementById(moudleId);
        if(id.className=="module collapsed"){
          id.className="module expanded";
        }else{
          id.className="module collapsed";
        }
      }
    }
  });

  bg.extend({'ui.load':
        function (module,callback){
          var base="/static";
          if(bg.getContextPath().length>1)
            base = bg.getContextPath() + base;
          if(module=="validity"){
            jQuery.struts2_jquery.requireCss("/themes/" + bg.uitheme + "/jquery.validity.css",base);
            jQuery.struts2_jquery.require("/scripts/plugins/jquery-validity.js",null,base);
            if(window.$BG_LANG) {
              if(window.$BG_LANG != 'en' && window.$BG_LANG != 'en_US') {
                jQuery.struts2_jquery.require("/scripts/i18n/zh_CN/jquery.validity.js",callback,base);
              }
            } else {
              jQuery.struts2_jquery.require("/scripts/i18n/zh_CN/jquery.validity.js",callback,base);
            }
          }else if(module=="tabletree"){
            jQuery.struts2_jquery.requireCss("/themes/" + bg.uitheme + "/beangle-ui-tabletree.css",base);
            jQuery.struts2_jquery.require("/scripts/beangle/beangle-ui-tabletree.js",callback,base);
          }else if(module=="colorbox"){
            jQuery.struts2_jquery.requireCss("/themes/" + bg.uitheme + "/colorbox.css",base);
            jQuery.struts2_jquery.require("/scripts/plugins/jquery-colorbox.min.js",callback,base);
          }else if(module=="jquery.pstrength"){
            jQuery.struts2_jquery.requireCss("/themes/" + bg.uitheme + "/jquery-pstrength.css",base);
            jQuery.struts2_jquery.require("/scripts/plugins/jquery-pstrength.js",callback,base);
            jQuery.struts2_jquery.require("/scripts/i18n/zh_CN/jquery-pstrength.js",callback,base);
          }
        }
  });
})(beangle);

