{% extends 'base.html' %}
{% block title %}用户设置{% endblock %}
{% block content %}
<div class="container mt-5">
    <h1 class="mb-4">用户设置</h1>
    
    <!-- 导航选项卡 -->
    <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active" id="security-tab" data-bs-toggle="tab" href="#security" role="tab" aria-controls="security" aria-selected="true">安全设置</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="account-tab" data-bs-toggle="tab" href="#account" role="tab" aria-controls="account" aria-selected="false">账户信息</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="activity-tab" data-bs-toggle="tab" href="#activity" role="tab" aria-controls="activity" aria-selected="false">活动记录</a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" id="data-tab" data-bs-toggle="tab" href="#data" role="tab" aria-controls="data" aria-selected="false">数据管理</a>
        </li>
    </ul>
    
    <!-- 选项卡内容 -->
    <div class="tab-content" id="settingsTabsContent">
        <!-- 安全设置选项卡 -->
        <div class="tab-pane fade show active" id="security" role="tabpanel" aria-labelledby="security-tab">
            <div class="row">
                <div class="col-md-8">
                    <!-- 密码修改表单 -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5>修改密码</h5>
                        </div>
                        <div class="card-body">
                            <form method="POST" action="" id="passwordForm">
                                <input type="hidden" name="form" value="password">
                                {{ form.csrf_token if form else '' }}
                                
                                <div class="form-group mb-3">
                                    <label for="old_password" class="form-label">当前密码</label>
                                    <input type="password" id="old_password" name="old_password" class="form-control" required>
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label for="new_password" class="form-label">新密码</label>
                                    <input type="password" id="new_password" name="new_password" class="form-control" required>
                                    <div class="form-text mt-1">
                                        {% if current_user.security_level >= 2 %}
                                        <small class="text-warning">密码必须包含大小写字母和数字</small>
                                        {% endif %}
                                        <small>密码长度至少8位</small>
                                    </div>
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label for="confirm_new" class="form-label">确认新密码</label>
                                    <input type="password" id="confirm_new" name="confirm_new" class="form-control" required>
                                </div>
                                
                                {% if profile and profile.last_password_change %}
                                <div class="form-text mb-3">
                                    <small>上次密码修改时间：{{ profile.last_password_change.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                                </div>
                                {% endif %}
                                
                                <button type="submit" class="btn btn-primary">更新密码</button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- 安全问题设置 -->
                    <div class="card mb-4">
                        <div class="card-header bg-secondary text-white">
                            <h5>安全问题设置</h5>
                        </div>
                        <div class="card-body">
                            <form method="POST" action="" id="securityForm">
                                <input type="hidden" name="form" value="security">
                                {{ form.csrf_token if form else '' }}
                                
                                <div class="form-group mb-3">
                                    <label for="question" class="form-label">安全问题</label>
                                    <select id="question" name="question" class="form-select">
                                        <option value="">请选择安全问题</option>
                                        <option value="您的出生地是哪里？" {% if profile and profile.question == '您的出生地是哪里？' %}selected{% endif %}>您的出生地是哪里？</option>
                                        <option value="您的小学班主任姓名？" {% if profile and profile.question == '您的小学班主任姓名？' %}selected{% endif %}>您的小学班主任姓名？</option>
                                        <option value="您的第一个宠物名字？" {% if profile and profile.question == '您的第一个宠物名字？' %}selected{% endif %}>您的第一个宠物名字？</option>
                                        <option value="您最喜欢的电影？" {% if profile and profile.question == '您最喜欢的电影？' %}selected{% endif %}>您最喜欢的电影？</option>
                                        <option value="您的身份证后四位？" {% if profile and profile.question == '您的身份证后四位？' %}selected{% endif %}>您的身份证后四位？</option>
                                    </select>
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label for="answer" class="form-label">安全答案</label>
                                    <input type="password" id="answer" name="answer" class="form-control" placeholder="请输入安全问题答案">
                                    <div class="form-text mt-1">
                                        <small>安全问题用于账户解锁和密码找回</small>
                                    </div>
                                </div>
                                
                                <div class="form-group mb-3 form-check">
                                    <input type="checkbox" id="two_factor_enabled" name="two_factor_enabled" class="form-check-input" {% if profile and profile.two_factor_enabled %}checked{% endif %}>
                                    <label for="two_factor_enabled" class="form-check-label">启用双因素认证 (开发中)</label>
                                </div>
                                
                                <button type="submit" class="btn btn-secondary">保存安全设置</button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- 安全等级设置 -->
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5>安全等级设置</h5>
                        </div>
                        <div class="card-body">
                            <form method="POST" action="" id="securityLevelForm">
                                <input type="hidden" name="form" value="security_level">
                                {{ form.csrf_token if form else '' }}
                                
                                <div class="form-group mb-3">
                                    <label for="security_level" class="form-label">选择安全等级</label>
                                    <select id="security_level" name="security_level" class="form-select">
                                        <option value="1" {% if current_user.security_level == 1 %}selected{% endif %}>低级别 (1) - 基础安全措施</option>
                                        <option value="2" {% if current_user.security_level == 2 %}selected{% endif %}>中级别 (2) - 密码复杂度要求</option>
                                        <option value="3" {% if current_user.security_level == 3 %}selected{% endif %}>高级别 (3) - 敏感操作需额外验证</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <h6>安全等级说明：</h6>
                                    <ul class="list-unstyled">
                                        <li class="mb-1"><strong>低级别(1):</strong> 仅基本密码要求，适用于测试或非重要账户</li>
                                        <li class="mb-1"><strong>中级别(2):</strong> 密码必须包含大小写字母和数字，提高安全性</li>
                                        <li class="mb-1"><strong>高级别(3):</strong> 最高安全保障，敏感操作需要额外验证步骤</li>
                                    </ul>
                                </div>
                                
                                <button type="submit" class="btn btn-info">更新安全等级</button>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- 安全状态侧边栏 -->
                <div class="col-md-4">
                    <div class="card mb-4">
                        <div class="card-header bg-danger text-white">
                            <h5>账户安全状态</h5>
                        </div>
                        <div class="card-body">
                            {% if profile %}
                                <div class="mb-3">
                                    <p><strong>账户状态：</strong>
                                    {% if profile.locked_until and profile.locked_until > now %}
                                        <span class="badge bg-danger">已锁定</span>
                                    {% else %}
                                        <span class="badge bg-success">正常</span>
                                    {% endif %}
                                    </p>
                                </div>
                                
                                <div class="mb-3">
                                    <p><strong>安全问题：</strong>
                                    {% if profile.question %}
                                        <span class="badge bg-success">已设置</span>
                                    {% else %}
                                        <span class="badge bg-warning">未设置</span>
                                    {% endif %}
                                    </p>
                                </div>
                                
                                <div class="mb-3">
                                    <p><strong>登录失败次数：</strong> {{ profile.failed_count or 0 }}</p>
                                </div>
                                
                                {% if profile.locked_until and profile.locked_until > now %}
                                <div class="alert alert-danger mt-3">
                                    <p>您的账户已被锁定，请使用安全问题解锁</p>
                                    <p>锁定时间：{{ profile.locked_until.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                                </div>
                                {% endif %}
                            {% endif %}
                            
                            <!-- 安全建议 -->
                            <div class="mt-4">
                                <h6>安全建议：</h6>
                                <ul class="list-unstyled space-y-1">
                                    <li><i class="fas fa-shield-alt text-primary mr-2"></i> 定期更换密码</li>
                                    <li><i class="fas fa-key text-primary mr-2"></i> 不要在多个网站使用相同密码</li>
                                    <li><i class="fas fa-question-circle text-primary mr-2"></i> 请记住您的安全问题答案</li>
                                    <li><i class="fas fa-bell text-primary mr-2"></i> 提高安全等级增强保护</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 账户信息选项卡 -->
        <div class="tab-pane fade" id="account" role="tabpanel" aria-labelledby="account-tab">
            <div class="card mb-4">
                <div class="card-header">
                    <h5>基本信息</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-sm-3 col-form-label"><strong>用户名：</strong></div>
                        <div class="col-sm-9">{{ current_user.username }}</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-3 col-form-label"><strong>邮箱：</strong></div>
                        <div class="col-sm-9">{{ current_user.email }}</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-3 col-form-label"><strong>注册时间：</strong></div>
                        <div class="col-sm-9">{{ current_user.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-3 col-form-label"><strong>上次登录：</strong></div>
                        <div class="col-sm-9">
                            {% if current_user.last_login %}
                                {{ current_user.last_login.strftime('%Y-%m-%d %H:%M:%S') }}
                            {% else %}
                                首次登录
                            {% endif %}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-3 col-form-label"><strong>用户角色：</strong></div>
                        <div class="col-sm-9">
                            {% if current_user.is_admin %}
                                <span class="badge bg-primary">管理员</span>
                            {% else %}
                                <span class="badge bg-secondary">普通用户</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            {% if current_user.is_admin %}
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5>管理员权限</h5>
                </div>
                <div class="card-body">
                    <p>您拥有管理员权限，可以访问系统管理功能。</p>
                    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-primary">进入管理后台</a>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- 活动记录选项卡 -->
        <div class="tab-pane fade" id="activity" role="tabpanel" aria-labelledby="activity-tab">
            <div class="card">
                <div class="card-header">
                    <h5>最近活动</h5>
                </div>
                <div class="card-body">
                    <p>活动记录功能开发中，敬请期待...</p>
                    <div class="alert alert-info mt-3">
                        <p>我们正在开发活动记录功能，届时您将可以查看：</p>
                        <ul>
                            <li>登录历史记录</li>
                            <li>设置修改记录</li>
                            <li>日记操作记录</li>
                            <li>安全相关事件</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 数据管理选项卡 -->
        <div class="tab-pane fade" id="data" role="tabpanel" aria-labelledby="data-tab">
            <div class="card mb-4">
                <div class="card-header">
                    <h5>数据导出</h5>
                </div>
                <div class="card-body">
                    <p>导出您的个人数据，包括日记内容和账户信息。</p>
                    <div class="mt-3">
                        <form method="POST" action="" id="exportForm">
                            <input type="hidden" name="form" value="export_data">
                            {{ form.csrf_token if form else '' }}
                            
                            <div class="form-group mb-3">
                                <label class="form-label">导出格式：</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="export_format" id="json_format" value="json" checked>
                                    <label class="form-check-label" for="json_format">JSON格式</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="export_format" id="txt_format" value="txt">
                                    <label class="form-check-label" for="txt_format">文本格式</label>
                                </div>
                            </div>
                            
                            <div class="form-group mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="include_entries" name="include_entries" checked>
                                    <label class="form-check-label" for="include_entries">包括日记内容</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="include_account" name="include_account">
                                    <label class="form-check-label" for="include_account">包括账户信息</label>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">导出数据</button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5>账户删除</h5>
                </div>
                <div class="card-body">
                    <p class="text-danger">警告：删除账户将永久删除所有数据，此操作不可撤销！</p>
                    
                    <div class="mt-3">
                        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteAccountModal">
                            删除我的账户
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 账户删除确认模态框 -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-labelledby="deleteAccountModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteAccountModalLabel">确认删除账户</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-danger mb-3">此操作将永久删除您的账户及所有相关数据，无法恢复！</p>
                <div class="alert alert-warning">
                    <p>请确认您了解以下后果：</p>
                    <ul>
                        <li>所有日记内容将被永久删除</li>
                        <li>账户信息将被移除</li>
                        <li>无法找回已删除的任何数据</li>
                    </ul>
                </div>
                <div class="form-group">
                    <label for="confirm_username" class="form-label">请输入您的用户名以确认：</label>
                    <input type="text" id="confirm_username" class="form-control" placeholder="输入用户名确认删除">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled>确认删除</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 表单验证
        const passwordForm = document.getElementById('passwordForm');
        const newPassword = document.getElementById('new_password');
        const confirmNew = document.getElementById('confirm_new');
        
        // 密码强度检查
        newPassword.addEventListener('input', function() {
            const password = this.value;
            if (password.length > 0) {
                // 检查基本长度
                if (password.length < 8) {
                    this.classList.add('border-danger');
                    this.classList.remove('border-warning', 'border-success');
                } 
                // 中高级安全等级要求检查
                else if ({{ current_user.security_level }} >= 2) {
                    const hasUpper = /[A-Z]/.test(password);
                    const hasLower = /[a-z]/.test(password);
                    const hasDigit = /[0-9]/.test(password);
                    
                    if (hasUpper && hasLower && hasDigit) {
                        this.classList.add('border-success');
                        this.classList.remove('border-warning', 'border-danger');
                    } else {
                        this.classList.add('border-warning');
                        this.classList.remove('border-danger', 'border-success');
                    }
                } else {
                    this.classList.add('border-success');
                    this.classList.remove('border-warning', 'border-danger');
                }
            } else {
                this.classList.remove('border-danger', 'border-warning', 'border-success');
            }
        });
        
        // 密码匹配检查
        confirmNew.addEventListener('input', function() {
            if (this.value && this.value !== newPassword.value) {
                this.classList.add('border-danger');
                this.classList.remove('border-success');
            } else if (this.value) {
                this.classList.add('border-success');
                this.classList.remove('border-danger');
            } else {
                this.classList.remove('border-danger', 'border-success');
            }
        });
        
        // 账户删除确认
        const confirmUsername = document.getElementById('confirm_username');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        
        confirmUsername.addEventListener('input', function() {
            confirmDeleteBtn.disabled = this.value !== '{{ current_user.username }}';
        });
        
        confirmDeleteBtn.addEventListener('click', function() {
            if (confirm('您确定要删除账户吗？此操作无法撤销！')) {
                // 这里可以添加账户删除的AJAX处理
                alert('账户删除功能开发中');
                $('#deleteAccountModal').modal('hide');
            }
        });
        
        // 表单提交时的验证
        passwordForm.addEventListener('submit', function(e) {
            // 检查密码匹配
            if (newPassword.value !== confirmNew.value) {
                e.preventDefault();
                alert('两次输入的新密码不一致！');
                confirmNew.focus();
                return false;
            }
            
            // 中高级安全等级的密码复杂性检查
            if ({{ current_user.security_level }} >= 2) {
                const password = newPassword.value;
                const hasUpper = /[A-Z]/.test(password);
                const hasLower = /[a-z]/.test(password);
                const hasDigit = /[0-9]/.test(password);
                
                if (!(hasUpper && hasLower && hasDigit)) {
                    e.preventDefault();
                    alert('密码必须包含大小写字母和数字！');
                    newPassword.focus();
                    return false;
                }
            }
        });
        
        // 初始化标签页
        const urlHash = window.location.hash;
        if (urlHash.startsWith('#')) {
            const tabId = urlHash.substring(1);
            const tabElement = document.querySelector(`a[data-bs-target="#${tabId}"]`);
            if (tabElement) {
                tabElement.click();
            }
        }
    });
</script>
{% endblock %}