{% extends 'base.html' %}
{% block title %}我的日记 - 日记管理系统{% endblock %}
{% block content %}
<div class="list-header">
  <h1>我的日记</h1>
  <a class="btn primary" href="{{ url_for('diary.create_entry') }}">新建日记</a>
</div>

<!-- 筛选区域 -->
<div class="filter-panel">
  <form method="get" action="{{ url_for('diary.diary_list') }}">
    <div class="row">
      <div class="col-md-3">
        <select name="category_id" class="form-control">
          <option value="">全部分类</option>
          {% for category in categories %}
          <option value="{{ category.id }}" {% if selected_category == category.id %}selected{% endif %}>{{ category.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <select name="mood" class="form-control">
          <option value="">全部心情</option>
          <option value="happy" {% if selected_mood == 'happy' %}selected{% endif %}>开心</option>
          <option value="excited" {% if selected_mood == 'excited' %}selected{% endif %}>兴奋</option>
          <option value="peaceful" {% if selected_mood == 'peaceful' %}selected{% endif %}>平静</option>
          <option value="sad" {% if selected_mood == 'sad' %}selected{% endif %}>难过</option>
          <option value="angry" {% if selected_mood == 'angry' %}selected{% endif %}>生气</option>
          <option value="anxious" {% if selected_mood == 'anxious' %}selected{% endif %}>焦虑</option>
          <option value="tired" {% if selected_mood == 'tired' %}selected{% endif %}>疲惫</option>
          <option value="grateful" {% if selected_mood == 'grateful' %}selected{% endif %}>感恩</option>
        </select>
      </div>
      <div class="col-md-4">
        <div class="input-group">
          <input type="text" name="search" class="form-control" placeholder="搜索日记标题或内容" value="{{ search }}">
          <button type="submit" class="btn primary">搜索</button>
        </div>
      </div>
      <div class="col-md-2">
        <a href="{{ url_for('diary.diary_list') }}" class="btn btn-secondary w-100">重置筛选</a>
      </div>
    </div>
  </form>
</div>

<!-- 日记列表 -->
{% if diaries %}
  <div class="diary-grid">
    {% for diary in diaries %}
      <div class="diary-card" id="entry-{{ diary.id }}">
        <div class="diary-card-header">
          <h3 class="diary-title">{{ diary.title }}</h3>
          {% if diary.is_private %}
          <span class="badge bg-warning">私密</span>
          {% endif %}
        </div>
        <div class="diary-meta">
          <span class="meta-item">
            <i class="bi bi-calendar-date"></i> {{ diary.created_at.strftime('%Y-%m-%d %H:%M') }}
          </span>
          {% if diary.mood %}
          <span class="meta-item">
            <i class="bi bi-emoji-{{ 'smile' if diary.mood in ['happy', 'excited'] else 'neutral' if diary.mood in ['peaceful', 'grateful'] else 'frown' }}"></i> 
            {{ {'happy':'开心', 'excited':'兴奋', 'peaceful':'平静', 'sad':'难过', 'angry':'生气', 'anxious':'焦虑', 'tired':'疲惫', 'grateful':'感恩'}.get(diary.mood, '未知') }}
          </span>
          {% endif %}
          {% if diary.category %}
          <span class="meta-item">
            <i class="bi bi-folder"></i> {{ diary.category.name }}
          </span>
          {% endif %}
        </div>
        <div class="diary-content">
          {{ diary.content[:150] }}{{ '...' if diary.content|length > 150 else '' }}
        </div>
        <div class="diary-actions">
          <a class="btn btn-sm" href="{{ url_for('diary.view_entry', entry_id=diary.id) }}">查看详情</a>
          <a class="btn btn-sm" href="{{ url_for('diary.edit_entry', entry_id=diary.id) }}">编辑</a>
          <form method="post" action="{{ url_for('diary.delete_entry', entry_id=diary.id) }}" class="delete-form" style="display:inline;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-sm danger" onclick="return confirm('确定要删除该日记吗？')">删除</button>
          </form>
        </div>
      </div>
    {% endfor %}
  </div>
  
  <!-- 分页 -->
  <div class="pagination">
    {% if pagination.has_prev %}
      <a class="btn" href="{{ url_for('diary.diary_list', page=pagination.prev_num, category_id=selected_category, mood=selected_mood, search=search) }}">上一页</a>
    {% endif %}
    <span>第 {{ pagination.page }} / {{ pagination.pages }} 页</span>
    {% if pagination.has_next %}
      <a class="btn" href="{{ url_for('diary.diary_list', page=pagination.next_num, category_id=selected_category, mood=selected_mood, search=search) }}">下一页</a>
    {% endif %}
  </div>
{% else %}
  <div class="empty-state">
    <div class="empty-icon"><i class="bi bi-book"></i></div>
    <h3>暂无日记</h3>
    <p>点击“新建日记”开始书写你的第一篇日记吧！</p>
    <a class="btn primary" href="{{ url_for('diary.create_entry') }}">新建日记</a>
  </div>
{% endif %}
{% endblock %}