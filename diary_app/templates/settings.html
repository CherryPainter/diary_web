{% extends 'base.html' %}
{% block title %}账户设置 - 日记管理系统{% endblock %}
{% block content %}
<div id="account" class="row gy-3">
  <div class="col-lg-3">
    <div class="card h-100">
      <div class="card-body">
        <div class="d-flex align-items-center gap-3 mb-2">
          <i class="bi bi-person-circle fs-1"></i>
          <div>
            <div class="fw-bold">{{ current_user.username }}</div>
            <div class="text-muted">{{ current_user.email }}</div>
            <div class="text-muted">注册于 {{ current_user.created_at.strftime('%Y-%m-%d') }}</div>
          </div>
        </div>
        <div class="small text-muted">在右侧进行账户安全相关设置。</div>
        <hr>
        <div class="d-grid gap-2">
          <a class="btn btn-outline-primary" href="#password">修改密码</a>
          <a class="btn btn-outline-primary" href="#security">辅助验证</a>
        </div>
        {% if profile and profile.failed_count and profile.failed_count >= 3 %}
          <div class="alert alert-warning mt-3 mb-0">账户当前处于锁定状态（失败次数：{{ profile.failed_count }}），可在登录页通过辅助验证解锁。</div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-9">
    <div id="password" class="card mb-3">
      <div class="card-header">修改密码</div>
      <div class="card-body">
        <form method="post" novalidate>
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="form" value="password">
          <div class="mb-3">
            <label class="form-label">旧密码</label>
            <input class="form-control" type="password" name="old_password" required>
          </div>
          <div class="mb-3">
            <label class="form-label">新密码</label>
            <input class="form-control" type="password" name="new_password" minlength="8" required>
            <div class="form-text">至少 8 位，建议包含字母、数字和符号。</div>
          </div>
          <div class="mb-3">
            <label class="form-label">确认新密码</label>
            <input class="form-control" type="password" name="confirm_new" minlength="8" required>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-primary" type="submit">保存修改</button>
            <a class="btn btn-outline-secondary" href="#account">返回顶部</a>
          </div>
        </form>
      </div>
    </div>

    <div id="security" class="card">
      <div class="card-header">辅助验证（安全问题）</div>
      <div class="card-body">
        <form method="post" novalidate>
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="form" value="security">
          <div class="mb-3">
            <label class="form-label">问题</label>
            <input class="form-control" type="text" name="question" value="{{ profile.question or '' }}" maxlength="255" required>
            <div class="form-text">例如：我最喜欢的城市是？</div>
          </div>
          <div class="mb-3">
            <label class="form-label">答案（将被加密保存）</label>
            <input class="form-control" type="password" name="answer" required>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-primary" type="submit">保存设置</button>
            <a class="btn btn-outline-secondary" href="#account">返回顶部</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}